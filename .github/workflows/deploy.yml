name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${SERVER_PATH}"
          
          # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –ø–∞–ø–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—É–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏)
          echo "Cleaning old files on server..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            cd ${SERVER_PATH} && 
            rm -rf * .[^.]* 2>/dev/null || true &&
            find . -mindepth 1 -delete 2>/dev/null || true
          "
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx –¥–ª—è API –ø—Ä–æ–∫—Å–∏
          echo "Copying nginx API proxy configs..."
          scp -o StrictHostKeyChecking=no nginx-api-proxy.conf ${SERVER_USER}@${SERVER_HOST}:/tmp/nginx-api-proxy.conf
          scp -o StrictHostKeyChecking=no nginx-calltouch-proxy.conf ${SERVER_USER}@${SERVER_HOST}:/tmp/nginx-calltouch-proxy.conf
          scp -o StrictHostKeyChecking=no nginx-calltouch-location.conf ${SERVER_USER}@${SERVER_HOST}:/tmp/nginx-calltouch-location.conf
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é api –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º PHP —Ñ–∞–π–ª–∞
          echo "Creating /api directory on server..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            mkdir -p ${SERVER_PATH}/api || exit 1
            echo '‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${SERVER_PATH}/api —Å–æ–∑–¥–∞–Ω–∞ –∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
            ls -la ${SERVER_PATH}/ | grep api || echo '‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è api –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ'
          " || { echo '‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é api!'; exit 1; }
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–¥ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          echo "Verifying /api directory exists..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            if [ ! -d ${SERVER_PATH}/api ]; then
              echo '‚ùå –û–®–ò–ë–ö–ê: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${SERVER_PATH}/api –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!'
              exit 1
            fi
            echo '‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è ${SERVER_PATH}/api —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
          " || { echo '‚ùå –û–®–ò–ë–ö–ê: –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è api –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!'; exit 1; }
          
          # –ö–æ–ø–∏—Ä—É–µ–º PHP –ø—Ä–æ–∫—Å–∏ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          echo "Copying PHP proxy files..."
          if [ ! -f api/lead-proxy.php ]; then
            echo '‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª api/lead-proxy.php –Ω–µ –Ω–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ!'
            exit 1
          fi
          if [ ! -f api/calltouch-proxy.php ]; then
            echo '‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª api/calltouch-proxy.php –Ω–µ –Ω–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ!'
            exit 1
          fi
          
          scp -o StrictHostKeyChecking=no api/lead-proxy.php ${SERVER_USER}@${SERVER_HOST}:"${SERVER_PATH}/api/lead-proxy.php" || { echo '‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å lead-proxy.php'; exit 1; }
          scp -o StrictHostKeyChecking=no api/calltouch-proxy.php ${SERVER_USER}@${SERVER_HOST}:"${SERVER_PATH}/api/calltouch-proxy.php" || { echo '‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å calltouch-proxy.php'; exit 1; }
          echo '‚úÖ PHP —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã'
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏—Å—å –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
          echo "Verifying PHP files and setting permissions..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            if [ -f ${SERVER_PATH}/api/lead-proxy.php ] && [ -f ${SERVER_PATH}/api/calltouch-proxy.php ]; then
              chmod 644 ${SERVER_PATH}/api/lead-proxy.php
              chmod 644 ${SERVER_PATH}/api/calltouch-proxy.php
              echo '‚úÖ PHP —Ñ–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã'
              ls -la ${SERVER_PATH}/api/*.php
            else
              echo '‚ùå –û–®–ò–ë–ö–ê: PHP —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ—Å–ª–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è!'
              exit 1
            fi
          "
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ dist –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          echo "Copying new files to server..."
          scp -o StrictHostKeyChecking=no -r dist/* ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
          
          # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, .htaccess), —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
          # scp -o StrictHostKeyChecking=no -r dist/.[^.]* ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/ 2>/dev/null || true
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º nginx –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è /api/lead-proxy
          echo "Configuring nginx for API proxy..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é PHP –∏ –ø—É—Ç—å –∫ —Å–æ–∫–µ—Ç—É
            PHP_SOCKET=\$(ls /var/run/php/php*-fpm.sock 2>/dev/null | head -1)
            if [ -z \"\$PHP_SOCKET\" ]; then
              # –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ TCP
              PHP_SOCKET='127.0.0.1:9000'
              echo '‚ö†Ô∏è  PHP-FPM socket –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º TCP: '\$PHP_SOCKET
            else
              echo '‚úÖ –ù–∞–π–¥–µ–Ω PHP-FPM socket: '\$PHP_SOCKET
            fi
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º document_root –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ nginx
            DOCUMENT_ROOT=\$(grep -E '^\s*root\s+' /etc/nginx/sites-enabled/*.conf 2>/dev/null | head -1 | awk '{print \$2}' | tr -d ';' || echo '${SERVER_PATH}')
            if [ -z \"\$DOCUMENT_ROOT\" ] || [ \"\$DOCUMENT_ROOT\" = \"${SERVER_PATH}\" ]; then
              DOCUMENT_ROOT='${SERVER_PATH}'
            fi
            echo 'üìÅ Document root: '\$DOCUMENT_ROOT
            
            # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏
            sudo mkdir -p /etc/nginx/includes
            sudo sed \"s|DOCUMENT_ROOT_PLACEHOLDER|\$DOCUMENT_ROOT|g; s|PHP_SOCKET_PLACEHOLDER|\$PHP_SOCKET|g; s|root /var/www/fcriverclub.ru;|root \$DOCUMENT_ROOT;|g; s|fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;|fastcgi_pass \$PHP_SOCKET;|g\" /tmp/nginx-api-proxy.conf > /tmp/api-proxy-custom.conf
            sudo cp /tmp/api-proxy-custom.conf /etc/nginx/includes/api-proxy.conf
            echo '‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏'
            echo 'üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ calltouch-proxy:'
            sudo grep -A 10 'location.*calltouch-proxy' /etc/nginx/includes/api-proxy.conf || echo '‚ö†Ô∏è  calltouch-proxy location –Ω–µ –Ω–∞–π–¥–µ–Ω'
            
            # –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ nginx
            NGINX_CONF=\$(ls /etc/nginx/sites-enabled/*.conf 2>/dev/null | head -1)
            if [ -z \"\$NGINX_CONF\" ]; then
              NGINX_CONF=\"/etc/nginx/sites-available/default\"
            fi
            
            # –ö–†–ò–¢–ò–ß–ù–û: –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ location –±–ª–æ–∫–∏, –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
            echo 'üîç –ü–æ–∏—Å–∫ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• —Å—Ç–∞—Ä—ã—Ö location –±–ª–æ–∫–æ–≤ –¥–ª—è /api/...'
            # –£–¥–∞–ª—è–µ–º location = /api/lead-proxy
            sudo sed -i '/location[[:space:]]*=[[:space:]]*\/api\/lead-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
            # –£–¥–∞–ª—è–µ–º location /api/lead-proxy
            sudo sed -i '/location[[:space:]]*\/api\/lead-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
            # –£–¥–∞–ª—è–µ–º location = /api/calltouch-proxy (–í–°–ï –≤–∞—Ä–∏–∞–Ω—Ç—ã)
            sudo sed -i '/location[[:space:]]*=[[:space:]]*\/api\/calltouch-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
            # –£–¥–∞–ª—è–µ–º location /api/calltouch-proxy
            sudo sed -i '/location[[:space:]]*\/api\/calltouch-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
            echo '‚úÖ –í—Å–µ —Å—Ç–∞—Ä—ã–µ location –±–ª–æ–∫–∏ —É–¥–∞–ª–µ–Ω—ã'
            
            # –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è–µ–º location –±–ª–æ–∫ –¥–ª—è calltouch-proxy –ù–ê–ü–†–Ø–ú–£–Æ –≤ –∫–æ–Ω—Ñ–∏–≥
            echo 'üìù –î–æ–±–∞–≤–ª—è–µ–º location –±–ª–æ–∫ –¥–ª—è calltouch-proxy –ù–ê–ü–†–Ø–ú–£–Æ –≤ –∫–æ–Ω—Ñ–∏–≥...'
            
            # –ö–æ–ø–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –∑–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
            sudo cp /tmp/nginx-calltouch-location.conf /tmp/calltouch-location.conf
            sudo sed -i \"s|DOCUMENT_ROOT_PLACEHOLDER|\$DOCUMENT_ROOT|g; s|PHP_SOCKET_PLACEHOLDER|\$PHP_SOCKET|g\" /tmp/calltouch-location.conf
            
            # –í—Å—Ç–∞–≤–ª—è–µ–º –ü–ï–†–ï–î location / –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–æ–π server
            if grep -q 'location[[:space:]]*/' \"\$NGINX_CONF\" 2>/dev/null; then
              # –í—Å—Ç–∞–≤–ª—è–µ–º –ü–ï–†–ï–î location /
              sudo sed -i '/location[[:space:]]*\//r /tmp/calltouch-location.conf' \"\$NGINX_CONF\"
              echo '‚úÖ Location –±–ª–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –ü–ï–†–ï–î location /'
            else
              # –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–æ–π server –±–ª–æ–∫–∞
              sudo awk 'FNR==NR{block=block\$0\"\\n\";next} /^[[:space:]]*server[[:space:]]*{/,/^[[:space:]]*}/ {if (/^[[:space:]]*}/ && !added) {printf \"%s\", block; added=1} print}' /tmp/calltouch-location.conf \"\$NGINX_CONF\" > \"\$NGINX_CONF.tmp\" && sudo mv \"\$NGINX_CONF.tmp\" \"\$NGINX_CONF\"
              echo '‚úÖ Location –±–ª–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–æ–π server'
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–ª–æ–∫ –¥–æ–±–∞–≤–∏–ª—Å—è
            if sudo grep -q 'location.*calltouch-proxy' \"\$NGINX_CONF\" 2>/dev/null; then
              echo '‚úÖ Location –±–ª–æ–∫ –¥–ª—è calltouch-proxy –Ω–∞–π–¥–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ñ–∏–≥–µ'
            else
              echo '‚ùå –û–®–ò–ë–ö–ê: Location –±–ª–æ–∫ –ù–ï –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥–µ!'
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
            if grep -q 'location.*\/api\/lead-proxy' \"\$NGINX_CONF\" 2>/dev/null; then
              echo '‚ö†Ô∏è  Warning: –í—Å–µ –µ—â–µ –µ—Å—Ç—å location /api/lead-proxy –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ñ–∏–≥–µ!'
              sudo grep -n 'location.*\/api\/lead-proxy' \"\$NGINX_CONF\" || true
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
            echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:'
            if ! sudo nginx -t; then
              echo '‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –Ω–µ–≤–∞–ª–∏–¥–Ω–∞!'
              exit 1
            fi
            
            # –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
            echo 'üîÑ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx...'
            sudo systemctl restart nginx 2>/dev/null || sudo service nginx restart 2>/dev/null || {
              echo '‚ö†Ô∏è  systemctl/service –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±—É–µ–º nginx -s reload...'
              sudo nginx -s reload
            }
            
            # –ñ–¥–µ–º —Å–µ–∫—É–Ω–¥—É —á—Ç–æ–±—ã nginx –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª—Å—è
            sleep 2
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ nginx —Ä–∞–±–æ—Ç–∞–µ—Ç
            if sudo systemctl is-active --quiet nginx || sudo service nginx status > /dev/null 2>&1; then
              echo '‚úÖ Nginx –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç'
            else
              echo '‚ö†Ô∏è Warning: nginx –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω'
            fi
            
            # –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ calltouch-proxy location –µ—Å—Ç—å –≤ –û–°–ù–û–í–ù–û–ú –∫–æ–Ω—Ñ–∏–≥–µ
            echo 'üîç –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:'
            if sudo grep -q 'location.*calltouch-proxy' \"\$NGINX_CONF\" 2>/dev/null; then
              echo '‚úÖ calltouch-proxy location –Ω–∞–π–¥–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ñ–∏–≥–µ'
              sudo grep -A 5 'location.*calltouch-proxy' \"\$NGINX_CONF\"
            else
              echo '‚ùå –û–®–ò–ë–ö–ê: calltouch-proxy location –ù–ï –Ω–∞–π–¥–µ–Ω –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ñ–∏–≥–µ!'
              echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ñ–∏–≥–∞:'
              sudo cat \"\$NGINX_CONF\" | tail -50
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª calltouch-proxy.php —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            if [ -f \"\$DOCUMENT_ROOT/api/calltouch-proxy.php\" ]; then
              echo '‚úÖ –§–∞–π–ª calltouch-proxy.php —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
              ls -la \"\$DOCUMENT_ROOT/api/calltouch-proxy.php\"
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
              sudo chmod 644 \"\$DOCUMENT_ROOT/api/calltouch-proxy.php\"
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ PHP –º–æ–∂–µ—Ç –µ–≥–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å
              if php -l \"\$DOCUMENT_ROOT/api/calltouch-proxy.php\" > /dev/null 2>&1; then
                echo '‚úÖ PHP —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Ñ–∞–π–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω'
              else
                echo '‚ö†Ô∏è  Warning: PHP —Å–∏–Ω—Ç–∞–∫—Å–∏—Å —Ñ–∞–π–ª–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω'
                php -l \"\$DOCUMENT_ROOT/api/calltouch-proxy.php\"
              fi
            else
              echo '‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª calltouch-proxy.php –ù–ï –Ω–∞–π–¥–µ–Ω!'
              echo 'üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ api:'
              ls -la \"\$DOCUMENT_ROOT/api/\" || echo '–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è api –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!'
              exit 1
            fi
            
            # –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: —Ç–µ—Å—Ç–∏—Ä—É–µ–º —á—Ç–æ Nginx –≤–∏–¥–∏—Ç location –±–ª–æ–∫
            echo 'üîç –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: Nginx –≤–∏–¥–∏—Ç location –±–ª–æ–∫?'
            NGINX_TEST=\$(sudo nginx -T 2>&1)
            if echo \"\$NGINX_TEST\" | grep -A 10 'location.*calltouch-proxy' > /dev/null; then
              echo '‚úÖ Nginx –≤–∏–¥–∏—Ç location –±–ª–æ–∫ –¥–ª—è calltouch-proxy'
              echo \"\$NGINX_TEST\" | grep -A 10 'location.*calltouch-proxy'
            else
              echo '‚ùå –û–®–ò–ë–ö–ê: Nginx –ù–ï –≤–∏–¥–∏—Ç location –±–ª–æ–∫ –¥–ª—è calltouch-proxy!'
              echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥ –Ω–∞–ø—Ä—è–º—É—é:'
              sudo grep -n 'location.*calltouch-proxy' \"\$NGINX_CONF\" || echo '–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ'
              echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ location –±–ª–æ–∫–∏ –≤ –∫–æ–Ω—Ñ–∏–≥–µ:'
              sudo grep 'location' \"\$NGINX_CONF\" | head -10
              echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:'
              ls -la \"\$DOCUMENT_ROOT/api/calltouch-proxy.php\"
              exit 1
            fi
          " || echo "‚ö†Ô∏è  Warning: nginx configuration step failed, but deployment continues"
          
          # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
          # ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "cd ${SERVER_PATH} && pm2 restart app || true"
          
          echo "‚úÖ Deployment completed successfully! All old files were removed and replaced."
