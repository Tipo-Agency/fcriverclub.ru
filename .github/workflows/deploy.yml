name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${SERVER_PATH}"
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
          echo "Cleaning old files on server..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            cd ${SERVER_PATH} && 
            rm -rf * .[^.]* 2>/dev/null || true
          "
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx –¥–ª—è API –ø—Ä–æ–∫—Å–∏
          echo "Copying nginx API proxy config..."
          scp -o StrictHostKeyChecking=no nginx-api-proxy.conf ${SERVER_USER}@${SERVER_HOST}:/tmp/nginx-api-proxy.conf
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é api –∏ –∫–æ–ø–∏—Ä—É–µ–º PHP —Ñ–∞–π–ª—ã
          echo "Creating /api directory and copying PHP files..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            mkdir -p ${SERVER_PATH}/api || exit 1
          " || { echo '‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é api!'; exit 1; }
          
          if [ ! -f api/lead-proxy.php ]; then
            echo '‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª api/lead-proxy.php –Ω–µ –Ω–∞–π–¥–µ–Ω!'
            exit 1
          fi
          
          scp -o StrictHostKeyChecking=no api/lead-proxy.php ${SERVER_USER}@${SERVER_HOST}:"${SERVER_PATH}/api/lead-proxy.php" || { echo '‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å lead-proxy.php'; exit 1; }
          echo '‚úÖ PHP —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã'
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            chmod 644 ${SERVER_PATH}/api/lead-proxy.php
          "
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          echo "Copying built files to server..."
          scp -o StrictHostKeyChecking=no -r dist/* ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º nginx (–∏—Å–ø–æ–ª—å–∑—É–µ–º sudo –±–µ–∑ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ NOPASSWD)
          echo "Configuring nginx..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            set -e
            
            # –ò—â–µ–º PHP-FPM socket
            PHP_SOCKET=''
            for sock in /var/run/php/php*-fpm.sock /var/run/php-fpm/php-fpm.sock; do
              if [ -S \"\$sock\" ] 2>/dev/null; then
                PHP_SOCKET=\"\$sock\"
                break
              fi
            done
            
            # –ï—Å–ª–∏ socket –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ systemctl
            if [ -z \"\$PHP_SOCKET\" ]; then
              PHP_SERVICE=\$(systemctl list-units --type=service 2>/dev/null | grep -o 'php[0-9.]*-fpm' | head -1 || true)
              if [ -n \"\$PHP_SERVICE\" ]; then
                PHP_VERSION=\$(echo \"\$PHP_SERVICE\" | grep -oE '[0-9.]+')
                PHP_SOCKET=\"/var/run/php/php\${PHP_VERSION}-fpm.sock\"
                if [ ! -S \"\$PHP_SOCKET\" ]; then
                  PHP_SOCKET='127.0.0.1:9000'
                fi
              else
                PHP_SOCKET='127.0.0.1:9000'
              fi
            fi
            
            echo '‚úÖ PHP-FPM socket: '\$PHP_SOCKET
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º document_root
            DOCUMENT_ROOT=\$(grep -E '^\s*root\s+' /etc/nginx/sites-enabled/*.conf 2>/dev/null | head -1 | awk '{print \$2}' | tr -d ';' || echo '${SERVER_PATH}')
            if [ -z \"\$DOCUMENT_ROOT\" ] || [ \"\$DOCUMENT_ROOT\" = \"${SERVER_PATH}\" ]; then
              DOCUMENT_ROOT='${SERVER_PATH}'
            fi
            echo 'üìÅ Document root: '\$DOCUMENT_ROOT
            
            # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é api-proxy.conf (–ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ sudo)
            echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ sudo –ø—Ä–∞–≤...'
            echo '–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: '$(whoami)
            echo '–ü—Ä–æ–≤–µ—Ä–∫–∞ sudo –±–µ–∑ –ø–∞—Ä–æ–ª—è...'
            
            # –ü—Ä–æ–±—É–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Å—Ç—É—é –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑ sudo
            if sudo -n mkdir -p /tmp/test_sudo_dir 2>/dev/null && sudo -n rmdir /tmp/test_sudo_dir 2>/dev/null; then
              echo '‚úÖ sudo —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–∞—Ä–æ–ª—è'
              # sudo —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–∞—Ä–æ–ª—è
              sudo mkdir -p /etc/nginx/includes
              sudo sed \"s|DOCUMENT_ROOT_PLACEHOLDER|\$DOCUMENT_ROOT|g; s|PHP_SOCKET_PLACEHOLDER|\$PHP_SOCKET|g\" /tmp/nginx-api-proxy.conf > /tmp/api-proxy-custom.conf
              sudo cp /tmp/api-proxy-custom.conf /etc/nginx/includes/api-proxy.conf
              echo '‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è api-proxy.conf —Å–æ–∑–¥–∞–Ω–∞'
              
              # –ù–∞—Ö–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥ nginx
              NGINX_CONF=\$(ls /etc/nginx/sites-enabled/*.conf 2>/dev/null | head -1)
              if [ -z \"\$NGINX_CONF\" ]; then
                NGINX_CONF=\"/etc/nginx/sites-available/default\"
              fi
              echo 'üìÑ Nginx config: '\$NGINX_CONF
              
              # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ location –±–ª–æ–∫–∏ –¥–ª—è /api/lead-proxy
              sudo sed -i '/location[[:space:]]*[=]*[[:space:]]*\/api\/lead-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
              
              # –î–æ–±–∞–≤–ª—è–µ–º include –¥–ª—è api-proxy.conf –ü–ï–†–ï–î location /
              if ! grep -q 'include.*api-proxy.conf' \"\$NGINX_CONF\" 2>/dev/null; then
                if grep -q 'location[[:space:]]*/' \"\$NGINX_CONF\" 2>/dev/null; then
                  sudo sed -i '/location[[:space:]]*\//i\    include /etc/nginx/includes/api-proxy.conf;' \"\$NGINX_CONF\"
                else
                  sudo awk '/^[[:space:]]*server[[:space:]]*{/,/^[[:space:]]*}/ {if (/^[[:space:]]*}/ && !added) {print \"    include /etc/nginx/includes/api-proxy.conf;\"; added=1} print}' \"\$NGINX_CONF\" > \"\$NGINX_CONF.tmp\" && sudo mv \"\$NGINX_CONF.tmp\" \"\$NGINX_CONF\"
                fi
                echo '‚úÖ Include –¥–ª—è api-proxy.conf –¥–æ–±–∞–≤–ª–µ–Ω'
              fi
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
              if ! sudo nginx -t; then
                echo '‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –Ω–µ–≤–∞–ª–∏–¥–Ω–∞!'
                sudo nginx -t
                exit 1
              fi
              
              # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
              echo 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx...'
              sudo systemctl restart nginx 2>/dev/null || sudo service nginx restart 2>/dev/null || sudo nginx -s reload
              sleep 1
              
              # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
              if sudo nginx -T 2>&1 | grep -q 'location.*lead-proxy'; then
                echo '‚úÖ Location –±–ª–æ–∫ –¥–ª—è lead-proxy –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx'
              else
                echo '‚ö†Ô∏è  Warning: Location –±–ª–æ–∫ –¥–ª—è lead-proxy –Ω–µ –Ω–∞–π–¥–µ–Ω'
              fi
            else
              echo '‚ùå –û–®–ò–ë–ö–ê: sudo —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–æ–ª—å!'
              echo '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:'
              echo '  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: '$(whoami)
              echo '  –ü—Ä–æ–≤–µ—Ä–∫–∞ sudoers —Ñ–∞–π–ª–æ–≤:'
              sudo cat /etc/sudoers.d/* 2>/dev/null | grep -i $(whoami) || echo '    –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø—Ä–∞–≤–∏–ª –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '$(whoami)
              echo '  –ü–æ–ø—Ä–æ–±—É–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –Ω–∞–ø—Ä—è–º—É—é (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—à–∏–±–∫–∞):'
              if sudo mkdir -p /etc/nginx/includes 2>&1; then
                echo '  ‚ö†Ô∏è  –ö–æ–º–∞–Ω–¥–∞ sudo mkdir —Å—Ä–∞–±–æ—Ç–∞–ª–∞, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ -n –Ω–µ –ø—Ä–æ—à–ª–∞'
                echo '  –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...'
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—ã–ª–∞ —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–æ–≥–æ–π
                sudo mkdir -p /etc/nginx/includes
              else
                echo '‚ùå –û–®–ò–ë–ö–ê: sudo –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–æ–ª—å!'
                echo '–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:'
                echo '  echo \"'$(whoami)' ALL=(ALL) NOPASSWD: /usr/bin/nginx, /bin/systemctl, /usr/sbin/service, /bin/sed, /bin/cp, /bin/mv, /bin/mkdir, /usr/bin/awk\" | sudo tee /etc/sudoers.d/'$(whoami)
                exit 1
              fi
            fi
          " || { echo '‚ùå –û–®–ò–ë–ö–ê: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx –Ω–µ —É–¥–∞–ª–∞—Å—å!'; exit 1; }
          
          echo "‚úÖ Deployment completed successfully!"
