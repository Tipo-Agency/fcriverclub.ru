name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะฝะฐ ัะตัะฒะตัะต
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${SERVER_PATH}"
          
          # ะัะธัะฐะตะผ ััะฐััะต ัะฐะนะปั
          echo "Cleaning old files on server..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            cd ${SERVER_PATH} && 
            rm -rf * .[^.]* 2>/dev/null || true
          "
          
          # ะะพะฟะธััะตะผ ะบะพะฝัะธะณััะฐัะธั nginx ะดะปั API ะฟัะพะบัะธ
          echo "Copying nginx API proxy config..."
          scp -o StrictHostKeyChecking=no nginx-api-proxy.conf ${SERVER_USER}@${SERVER_HOST}:/tmp/nginx-api-proxy.conf
          
          # ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั api ะธ ะบะพะฟะธััะตะผ PHP ัะฐะนะปั
          echo "Creating /api directory and copying PHP files..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            mkdir -p ${SERVER_PATH}/api || exit 1
          " || { echo 'โ ะะจะะะะ: ะะต ัะดะฐะปะพัั ัะพะทะดะฐัั ะดะธัะตะบัะพัะธั api!'; exit 1; }
          
          if [ ! -f api/lead-proxy.php ]; then
            echo 'โ ะะจะะะะ: ะคะฐะนะป api/lead-proxy.php ะฝะต ะฝะฐะนะดะตะฝ!'
            exit 1
          fi
          
          scp -o StrictHostKeyChecking=no api/lead-proxy.php ${SERVER_USER}@${SERVER_HOST}:"${SERVER_PATH}/api/lead-proxy.php" || { echo 'โ ะะจะะะะ: ะะต ัะดะฐะปะพัั ัะบะพะฟะธัะพะฒะฐัั lead-proxy.php'; exit 1; }
          echo 'โ PHP ัะฐะนะปั ัะบะพะฟะธัะพะฒะฐะฝั'
          
          # ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะฐะฒะฐ
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            chmod 644 ${SERVER_PATH}/api/lead-proxy.php
          "
          
          # ะะพะฟะธััะตะผ ัะพะฑัะฐะฝะฝัะต ัะฐะนะปั
          echo "Copying built files to server..."
          scp -o StrictHostKeyChecking=no -r dist/* ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
          
          # ะะฐัััะฐะธะฒะฐะตะผ nginx (ะธัะฟะพะปัะทัะตะผ sudo ะฑะตะท ะฟะฐัะพะปั ัะตัะตะท NOPASSWD)
          echo "Configuring nginx..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            set -e
            
            # ะัะตะผ PHP-FPM socket
            PHP_SOCKET=''
            for sock in /var/run/php/php*-fpm.sock /var/run/php-fpm/php-fpm.sock; do
              if [ -S \"\$sock\" ] 2>/dev/null; then
                PHP_SOCKET=\"\$sock\"
                break
              fi
            done
            
            # ะัะปะธ socket ะฝะต ะฝะฐะนะดะตะฝ, ะฟัะพะฑัะตะผ ัะตัะตะท systemctl
            if [ -z \"\$PHP_SOCKET\" ]; then
              PHP_SERVICE=\$(systemctl list-units --type=service 2>/dev/null | grep -o 'php[0-9.]*-fpm' | head -1 || true)
              if [ -n \"\$PHP_SERVICE\" ]; then
                PHP_VERSION=\$(echo \"\$PHP_SERVICE\" | grep -oE '[0-9.]+')
                PHP_SOCKET=\"/var/run/php/php\${PHP_VERSION}-fpm.sock\"
                if [ ! -S \"\$PHP_SOCKET\" ]; then
                  PHP_SOCKET='127.0.0.1:9000'
                fi
              else
                PHP_SOCKET='127.0.0.1:9000'
              fi
            fi
            
            echo 'โ PHP-FPM socket: '\$PHP_SOCKET
            
            # ะะฟัะตะดะตะปัะตะผ document_root
            DOCUMENT_ROOT=\$(grep -E '^\s*root\s+' /etc/nginx/sites-enabled/*.conf 2>/dev/null | head -1 | awk '{print \$2}' | tr -d ';' || echo '${SERVER_PATH}')
            if [ -z \"\$DOCUMENT_ROOT\" ] || [ \"\$DOCUMENT_ROOT\" = \"${SERVER_PATH}\" ]; then
              DOCUMENT_ROOT='${SERVER_PATH}'
            fi
            echo '๐ Document root: '\$DOCUMENT_ROOT
            
            # ะกะพะทะดะฐะตะผ ะบะพะฝัะธะณััะฐัะธั api-proxy.conf (ะฟัะพะฒะตััะตะผ ะฟัะฐะฒะฐ ะฝะฐ sudo ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั deploy)
            echo '๐ ะัะพะฒะตัะบะฐ sudo ะฟัะฐะฒ ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั deploy...'
            
            # ะัะพะฒะตััะตะผ, ะบะฐะบะธะต ะฟัะฐะฒะธะปะฐ sudo ะตััั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั deploy
            echo 'ะัะพะฒะตัะบะฐ ะฟัะฐะฒะธะป sudoers ะดะปั deploy:'
            if sudo test -f /etc/sudoers.d/deploy 2>/dev/null; then
              echo 'โ ะคะฐะนะป /etc/sudoers.d/deploy ัััะตััะฒัะตั:'
              sudo cat /etc/sudoers.d/deploy 2>/dev/null || echo '  โ๏ธ  ะะต ัะดะฐะปะพัั ะฟัะพัะธัะฐัั ัะฐะนะป'
            else
              echo 'โ ะคะฐะนะป /etc/sudoers.d/deploy ะะ ะฝะฐะนะดะตะฝ!'
            fi
            
            # ะัะพะฑัะตะผ ะฒัะฟะพะปะฝะธัั ะฟัะพัััั ะบะพะผะฐะฝะดั ัะตัะตะท sudo (ะฟัะพะฒะตััะตะผ NOPASSWD)
            echo 'ะัะพะฒะตัะบะฐ sudo ะฑะตะท ะฟะฐัะพะปั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั deploy...'
            if sudo -n mkdir -p /tmp/test_sudo_dir 2>/dev/null && sudo -n rmdir /tmp/test_sudo_dir 2>/dev/null; then
              echo 'โ sudo ัะฐะฑะพัะฐะตั ะฑะตะท ะฟะฐัะพะปั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั ะดะตะฟะปะพั'
              # sudo ัะฐะฑะพัะฐะตั ะฑะตะท ะฟะฐัะพะปั
              sudo mkdir -p /etc/nginx/includes
              
              # ะะะะขะะงะะ: ะฃะดะฐะปัะตะผ ััะฐััะน ัะฐะนะป api-proxy.conf ะตัะปะธ ะพะฝ ัะพะดะตัะถะธั proxy_pass ะฝะฐ 1C
              if [ -f /etc/nginx/includes/api-proxy.conf ]; then
                if sudo grep -q 'proxy_pass.*cloud\.1c\.fitness' /etc/nginx/includes/api-proxy.conf 2>/dev/null; then
                  echo 'โ๏ธ  ะะฑะฝะฐััะถะตะฝ ััะฐััะน ัะฐะนะป api-proxy.conf ั proxy_pass ะฝะฐ 1C! ะฃะดะฐะปัะตะผ...'
                  sudo rm /etc/nginx/includes/api-proxy.conf
                  echo 'โ ะกัะฐััะน ัะฐะนะป ัะดะฐะปะตะฝ'
                fi
              fi
              
              # ะกะพะทะดะฐะตะผ ะฝะพะฒัะน ัะฐะนะป ั ะฟัะฐะฒะธะปัะฝะพะน ะบะพะฝัะธะณััะฐัะธะตะน (fastcgi_pass, ะฐ ะฝะต proxy_pass)
              sudo sed \"s|DOCUMENT_ROOT_PLACEHOLDER|\$DOCUMENT_ROOT|g; s|PHP_SOCKET_PLACEHOLDER|\$PHP_SOCKET|g\" /tmp/nginx-api-proxy.conf > /tmp/api-proxy-custom.conf
              
              # ะัะพะฒะตััะตะผ ััะพ ะฒ ะฝะพะฒะพะผ ัะฐะนะปะต ะะะข proxy_pass ะฝะฐ 1C
              if grep -q 'proxy_pass.*cloud\.1c\.fitness' /tmp/api-proxy-custom.conf 2>/dev/null; then
                echo 'โ ะะจะะะะ: ะ ะฝะพะฒะพะผ ัะฐะนะปะต ะฝะฐะนะดะตะฝ proxy_pass ะฝะฐ 1C! ะญัะพ ะฝะตะฟัะฐะฒะธะปัะฝะพ!'
                exit 1
              fi
              
              # ะัะพะฒะตััะตะผ ััะพ ะฒ ะฝะพะฒะพะผ ัะฐะนะปะต ะะกะขะฌ fastcgi_pass
              if ! grep -q 'fastcgi_pass' /tmp/api-proxy-custom.conf 2>/dev/null; then
                echo 'โ ะะจะะะะ: ะ ะฝะพะฒะพะผ ัะฐะนะปะต ะะ ะฝะฐะนะดะตะฝ fastcgi_pass!'
                exit 1
              fi
              
              # ะะพะฟะธััะตะผ ะฝะพะฒัะน ัะฐะนะป
              sudo cp /tmp/api-proxy-custom.conf /etc/nginx/includes/api-proxy.conf
              echo 'โ ะะพะฝัะธะณััะฐัะธั api-proxy.conf ัะพะทะดะฐะฝะฐ ะธ ะฟัะพะฒะตัะตะฝะฐ (ะธัะฟะพะปัะทัะตััั fastcgi_pass, ะฝะต proxy_pass)'
              
              # ะะฐัะพะดะธะผ ะพัะฝะพะฒะฝะพะน ะบะพะฝัะธะณ nginx
              NGINX_CONF=\$(ls /etc/nginx/sites-enabled/*.conf 2>/dev/null | head -1)
              if [ -z \"\$NGINX_CONF\" ]; then
                NGINX_CONF=\"/etc/nginx/sites-available/default\"
              fi
              echo '๐ Nginx config: '\$NGINX_CONF
              
              # ะฃะดะฐะปัะตะผ ะะกะ ััะฐััะต location ะฑะปะพะบะธ ะดะปั /api/lead-proxy (ะฒะบะปััะฐั ัะต ััะพ ะฟัะพะบัะธัััั ะฒ 1C)
              echo '๐ ะฃะดะฐะปะตะฝะธะต ะฒัะตั ััะฐััั location ะฑะปะพะบะพะฒ ะดะปั /api/lead-proxy...'
              # ะฃะดะฐะปัะตะผ location = /api/lead-proxy
              sudo sed -i '/location[[:space:]]*=[[:space:]]*\/api\/lead-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
              # ะฃะดะฐะปัะตะผ location /api/lead-proxy (ะฑะตะท =)
              sudo sed -i '/location[[:space:]]*\/api\/lead-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
              # ะฃะดะฐะปัะตะผ ัััะพะบะธ ั proxy_pass ะฝะฐ 1C ะฒะฝัััะธ location ะฑะปะพะบะพะฒ
              sudo sed -i '/proxy_pass.*cloud\.1c\.fitness.*lead.*Webhook/d' \"\$NGINX_CONF\" 2>/dev/null || true
              echo 'โ ะัะต ััะฐััะต location ะฑะปะพะบะธ ัะดะฐะปะตะฝั'
              
              # ะะพะฑะฐะฒะปัะตะผ include ะดะปั api-proxy.conf ะะะะะ location /
              if ! grep -q 'include.*api-proxy.conf' \"\$NGINX_CONF\" 2>/dev/null; then
                if grep -q 'location[[:space:]]*/' \"\$NGINX_CONF\" 2>/dev/null; then
                  sudo sed -i '/location[[:space:]]*\//i\    include /etc/nginx/includes/api-proxy.conf;' \"\$NGINX_CONF\"
                else
                  sudo awk '/^[[:space:]]*server[[:space:]]*{/,/^[[:space:]]*}/ {if (/^[[:space:]]*}/ && !added) {print \"    include /etc/nginx/includes/api-proxy.conf;\"; added=1} print}' \"\$NGINX_CONF\" > \"\$NGINX_CONF.tmp\" && sudo mv \"\$NGINX_CONF.tmp\" \"\$NGINX_CONF\"
                fi
                echo 'โ Include ะดะปั api-proxy.conf ะดะพะฑะฐะฒะปะตะฝ'
              fi
              
              # ะัะพะฒะตััะตะผ ะบะพะฝัะธะณััะฐัะธั
              if ! sudo nginx -t; then
                echo 'โ ะะจะะะะ: ะะพะฝัะธะณััะฐัะธั nginx ะฝะตะฒะฐะปะธะดะฝะฐ!'
                sudo nginx -t
                exit 1
              fi
              
              # ะะตัะตะทะฐะณััะถะฐะตะผ nginx
              echo '๐ ะะตัะตะทะฐะณััะทะบะฐ nginx...'
              sudo systemctl restart nginx 2>/dev/null || sudo service nginx restart 2>/dev/null || sudo nginx -s reload
              sleep 1
              
              # ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
              echo '๐ ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ ะบะพะฝัะธะณััะฐัะธะธ nginx...'
              NGINX_TEST=\$(sudo nginx -T 2>&1)
              if echo \"\$NGINX_TEST\" | grep -q 'location.*lead-proxy'; then
                echo 'โ Location ะฑะปะพะบ ะดะปั lead-proxy ะฝะฐะนะดะตะฝ ะฒ ะบะพะฝัะธะณััะฐัะธะธ nginx'
                echo 'ะัะพะฒะตััะตะผ ััะพ ะธัะฟะพะปัะทัะตััั fastcgi_pass (PHP), ะฐ ะฝะต proxy_pass (1C):'
                if echo \"\$NGINX_TEST\" | grep -A 10 'location.*lead-proxy' | grep -q 'fastcgi_pass'; then
                  echo 'โ ะัะฟะพะปัะทัะตััั fastcgi_pass (PHP) - ะฟัะฐะฒะธะปัะฝะพ!'
                elif echo \"\$NGINX_TEST\" | grep -A 10 'location.*lead-proxy' | grep -q 'proxy_pass.*1c'; then
                  echo 'โ ะะจะะะะ: ะะฐะนะดะตะฝ proxy_pass ะฝะฐ 1C! ะญัะพ ะฝะตะฟัะฐะฒะธะปัะฝะพ, ะฝัะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั PHP!'
                  exit 1
                else
                  echo 'โ๏ธ  Warning: ะะต ัะดะฐะปะพัั ะพะฟัะตะดะตะปะธัั ัะธะฟ ะฟัะพะบัะธัะพะฒะฐะฝะธั'
                fi
              else
                echo 'โ๏ธ  Warning: Location ะฑะปะพะบ ะดะปั lead-proxy ะฝะต ะฝะฐะนะดะตะฝ'
              fi
            else
              echo 'โ ะะจะะะะ: sudo ััะตะฑัะตั ะฟะฐัะพะปั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั deploy!'
              echo ''
              echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
              echo 'ะงะขะ ะะฃะะะ ะกะะะะะขะฌ ะะ ะกะะะะะะ:'
              echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
              echo ''
              echo '1. ะะฐะนะดะธ ะฝะฐ ัะตัะฒะตั ะฟะพะด root (ะธะปะธ ัะตัะตะท sudo su)'
              echo ''
              echo '2. ะกะพะทะดะฐะน ัะฐะนะป /etc/sudoers.d/deploy ั ัะฐะบะธะผ ัะพะดะตัะถะธะผัะผ:'
              echo '   deploy ALL=(ALL) NOPASSWD: /usr/bin/nginx, /bin/systemctl, /usr/sbin/service, /bin/sed, /bin/cp, /bin/mv, /bin/mkdir, /usr/bin/awk'
              echo ''
              echo '3. ะัะฟะพะปะฝะธ ะบะพะผะฐะฝะดั:'
              echo '   echo "deploy ALL=(ALL) NOPASSWD: /usr/bin/nginx, /bin/systemctl, /usr/sbin/service, /bin/sed, /bin/cp, /bin/mv, /bin/mkdir, /usr/bin/awk" | sudo tee /etc/sudoers.d/deploy'
              echo '   sudo chmod 0440 /etc/sudoers.d/deploy'
              echo '   sudo visudo -c'
              echo ''
              echo '4. ะัะพะฒะตัั ััะพ ัะฐะฑะพัะฐะตั:'
              echo '   sudo -u deploy sudo -n mkdir -p /tmp/test && echo "โ ะะฐะฑะพัะฐะตั" || echo "โ ะะต ัะฐะฑะพัะฐะตั"'
              echo ''
              echo 'ะะะะะ: ะ ัะฐะนะปะต ะดะพะปะถะฝะพ ะฑััั ะธะผะตะฝะฝะพ "deploy", ะฐ ะะ "USERNAME" ะธะปะธ ะดััะณะพะต ะธะผั!'
              echo 'โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ'
              exit 1
            fi
          " || { echo 'โ ะะจะะะะ: ะะฐัััะพะนะบะฐ nginx ะฝะต ัะดะฐะปะฐัั!'; exit 1; }
          
          echo "โ Deployment completed successfully!"
