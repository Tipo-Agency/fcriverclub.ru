name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${SERVER_PATH}"
          
          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
          echo "Cleaning old files on server..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            cd ${SERVER_PATH} && 
            rm -rf * .[^.]* 2>/dev/null || true
          "
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx –¥–ª—è API –ø—Ä–æ–∫—Å–∏
          echo "Copying nginx API proxy config..."
          scp -o StrictHostKeyChecking=no nginx-api-proxy.conf ${SERVER_USER}@${SERVER_HOST}:/tmp/nginx-api-proxy.conf
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é api –∏ –∫–æ–ø–∏—Ä—É–µ–º PHP —Ñ–∞–π–ª—ã
          echo "Creating /api directory and copying PHP files..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            mkdir -p ${SERVER_PATH}/api || exit 1
          " || { echo '‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é api!'; exit 1; }
          
          if [ ! -f api/lead-proxy.php ]; then
            echo '‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª api/lead-proxy.php –Ω–µ –Ω–∞–π–¥–µ–Ω!'
            exit 1
          fi
          
          scp -o StrictHostKeyChecking=no api/lead-proxy.php ${SERVER_USER}@${SERVER_HOST}:"${SERVER_PATH}/api/lead-proxy.php" || { echo '‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å lead-proxy.php'; exit 1; }
          echo '‚úÖ PHP —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã'
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            chmod 644 ${SERVER_PATH}/api/lead-proxy.php
          "
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          echo "Copying built files to server..."
          scp -o StrictHostKeyChecking=no -r dist/* ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º nginx (–∏—Å–ø–æ–ª—å–∑—É–µ–º sudo –±–µ–∑ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ NOPASSWD)
          echo "Configuring nginx..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            set -e
            
            # –ò—â–µ–º PHP-FPM socket
            PHP_SOCKET=''
            for sock in /var/run/php/php*-fpm.sock /var/run/php-fpm/php-fpm.sock; do
              if [ -S \"\$sock\" ] 2>/dev/null; then
                PHP_SOCKET=\"\$sock\"
                break
              fi
            done
            
            # –ï—Å–ª–∏ socket –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ systemctl
            if [ -z \"\$PHP_SOCKET\" ]; then
              PHP_SERVICE=\$(systemctl list-units --type=service 2>/dev/null | grep -o 'php[0-9.]*-fpm' | head -1 || true)
              if [ -n \"\$PHP_SERVICE\" ]; then
                PHP_VERSION=\$(echo \"\$PHP_SERVICE\" | grep -oE '[0-9.]+')
                PHP_SOCKET=\"/var/run/php/php\${PHP_VERSION}-fpm.sock\"
                if [ ! -S \"\$PHP_SOCKET\" ]; then
                  PHP_SOCKET='127.0.0.1:9000'
                fi
              else
                PHP_SOCKET='127.0.0.1:9000'
              fi
            fi
            
            echo '‚úÖ PHP-FPM socket: '\$PHP_SOCKET
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º document_root
            DOCUMENT_ROOT=\$(grep -E '^\s*root\s+' /etc/nginx/sites-enabled/*.conf 2>/dev/null | head -1 | awk '{print \$2}' | tr -d ';' || echo '${SERVER_PATH}')
            if [ -z \"\$DOCUMENT_ROOT\" ] || [ \"\$DOCUMENT_ROOT\" = \"${SERVER_PATH}\" ]; then
              DOCUMENT_ROOT='${SERVER_PATH}'
            fi
            echo 'üìÅ Document root: '\$DOCUMENT_ROOT
            
            # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é api-proxy.conf (–ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ sudo –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–ø–ª–æ—è)
            echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ sudo –ø—Ä–∞–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–ø–ª–æ—è: ${SERVER_USER}'
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ sudo –µ—Å—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–ø–ª–æ—è
            echo '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª sudoers –¥–ª—è ${SERVER_USER}:'
            if sudo test -f /etc/sudoers.d/${SERVER_USER} 2>/dev/null; then
              echo '‚úÖ –§–∞–π–ª /etc/sudoers.d/${SERVER_USER} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:'
              sudo cat /etc/sudoers.d/${SERVER_USER} 2>/dev/null || echo '  ‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª'
            else
              echo '‚ùå –§–∞–π–ª /etc/sudoers.d/${SERVER_USER} –ù–ï –Ω–∞–π–¥–µ–Ω!'
            fi
            
            # –ü—Ä–æ–±—É–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ—Å—Ç—É—é –∫–æ–º–∞–Ω–¥—É —á–µ—Ä–µ–∑ sudo (–ø—Ä–æ–≤–µ—Ä—è–µ–º NOPASSWD)
            echo '–ü—Ä–æ–≤–µ—Ä–∫–∞ sudo –±–µ–∑ –ø–∞—Ä–æ–ª—è...'
            # –ü—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–º –Ω—É–∂–Ω—ã
            if sudo -n mkdir -p /tmp/test_sudo_dir 2>/dev/null && sudo -n rmdir /tmp/test_sudo_dir 2>/dev/null; then
              echo '‚úÖ sudo —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–∞—Ä–æ–ª—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–ø–ª–æ—è'
              # sudo —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–∞—Ä–æ–ª—è
              sudo mkdir -p /etc/nginx/includes
              
              # –ö–†–ò–¢–ò–ß–ù–û: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª api-proxy.conf –µ—Å–ª–∏ –æ–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç proxy_pass –Ω–∞ 1C
              if [ -f /etc/nginx/includes/api-proxy.conf ]; then
                if sudo grep -q 'proxy_pass.*cloud\.1c\.fitness' /etc/nginx/includes/api-proxy.conf 2>/dev/null; then
                  echo '‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª api-proxy.conf —Å proxy_pass –Ω–∞ 1C! –£–¥–∞–ª—è–µ–º...'
                  sudo rm /etc/nginx/includes/api-proxy.conf
                  echo '‚úÖ –°—Ç–∞—Ä—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω'
                fi
              fi
              
              # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π (fastcgi_pass, –∞ –Ω–µ proxy_pass)
              sudo sed \"s|DOCUMENT_ROOT_PLACEHOLDER|\$DOCUMENT_ROOT|g; s|PHP_SOCKET_PLACEHOLDER|\$PHP_SOCKET|g\" /tmp/nginx-api-proxy.conf > /tmp/api-proxy-custom.conf
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ –Ω–æ–≤–æ–º —Ñ–∞–π–ª–µ –ù–ï–¢ proxy_pass –Ω–∞ 1C
              if grep -q 'proxy_pass.*cloud\.1c\.fitness' /tmp/api-proxy-custom.conf 2>/dev/null; then
                echo '‚ùå –û–®–ò–ë–ö–ê: –í –Ω–æ–≤–æ–º —Ñ–∞–π–ª–µ –Ω–∞–π–¥–µ–Ω proxy_pass –Ω–∞ 1C! –≠—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!'
                exit 1
              fi
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤ –Ω–æ–≤–æ–º —Ñ–∞–π–ª–µ –ï–°–¢–¨ fastcgi_pass
              if ! grep -q 'fastcgi_pass' /tmp/api-proxy-custom.conf 2>/dev/null; then
                echo '‚ùå –û–®–ò–ë–ö–ê: –í –Ω–æ–≤–æ–º —Ñ–∞–π–ª–µ –ù–ï –Ω–∞–π–¥–µ–Ω fastcgi_pass!'
                exit 1
              fi
              
              # –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
              sudo cp /tmp/api-proxy-custom.conf /etc/nginx/includes/api-proxy.conf
              echo '‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è api-proxy.conf —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fastcgi_pass, –Ω–µ proxy_pass)'
              
              # –ù–∞—Ö–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥ nginx
              NGINX_CONF=\$(ls /etc/nginx/sites-enabled/*.conf 2>/dev/null | head -1)
              if [ -z \"\$NGINX_CONF\" ]; then
                NGINX_CONF=\"/etc/nginx/sites-available/default\"
              fi
              echo 'üìÑ Nginx config: '\$NGINX_CONF
              
              # –£–¥–∞–ª—è–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ location –±–ª–æ–∫–∏ –¥–ª—è /api/lead-proxy (–≤–∫–ª—é—á–∞—è —Ç–µ —á—Ç–æ –ø—Ä–æ–∫—Å–∏—Ä—É—é—Ç –≤ 1C)
              echo 'üîç –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç–∞—Ä—ã—Ö location –±–ª–æ–∫–æ–≤ –¥–ª—è /api/lead-proxy...'
              # –£–¥–∞–ª—è–µ–º location = /api/lead-proxy
              sudo sed -i '/location[[:space:]]*=[[:space:]]*\/api\/lead-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
              # –£–¥–∞–ª—è–µ–º location /api/lead-proxy (–±–µ–∑ =)
              sudo sed -i '/location[[:space:]]*\/api\/lead-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
              # –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å proxy_pass –Ω–∞ 1C –≤–Ω—É—Ç—Ä–∏ location –±–ª–æ–∫–æ–≤
              sudo sed -i '/proxy_pass.*cloud\.1c\.fitness.*lead.*Webhook/d' \"\$NGINX_CONF\" 2>/dev/null || true
              echo '‚úÖ –í—Å–µ —Å—Ç–∞—Ä—ã–µ location –±–ª–æ–∫–∏ —É–¥–∞–ª–µ–Ω—ã'
              
              # –î–æ–±–∞–≤–ª—è–µ–º include –¥–ª—è api-proxy.conf –ü–ï–†–ï–î location /
              if ! grep -q 'include.*api-proxy.conf' \"\$NGINX_CONF\" 2>/dev/null; then
                if grep -q 'location[[:space:]]*/' \"\$NGINX_CONF\" 2>/dev/null; then
                  sudo sed -i '/location[[:space:]]*\//i\    include /etc/nginx/includes/api-proxy.conf;' \"\$NGINX_CONF\"
                else
                  sudo awk '/^[[:space:]]*server[[:space:]]*{/,/^[[:space:]]*}/ {if (/^[[:space:]]*}/ && !added) {print \"    include /etc/nginx/includes/api-proxy.conf;\"; added=1} print}' \"\$NGINX_CONF\" > \"\$NGINX_CONF.tmp\" && sudo mv \"\$NGINX_CONF.tmp\" \"\$NGINX_CONF\"
                fi
                echo '‚úÖ Include –¥–ª—è api-proxy.conf –¥–æ–±–∞–≤–ª–µ–Ω'
              fi
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
              if ! sudo nginx -t; then
                echo '‚ùå –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –Ω–µ–≤–∞–ª–∏–¥–Ω–∞!'
                sudo nginx -t
                exit 1
              fi
              
              # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx
              echo 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx...'
              sudo systemctl restart nginx 2>/dev/null || sudo service nginx restart 2>/dev/null || sudo nginx -s reload
              sleep 1
              
              # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
              echo 'üîç –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx...'
              NGINX_TEST=\$(sudo nginx -T 2>&1)
              if echo \"\$NGINX_TEST\" | grep -q 'location.*lead-proxy'; then
                echo '‚úÖ Location –±–ª–æ–∫ –¥–ª—è lead-proxy –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ nginx'
                echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fastcgi_pass (PHP), –∞ –Ω–µ proxy_pass (1C):'
                if echo \"\$NGINX_TEST\" | grep -A 10 'location.*lead-proxy' | grep -q 'fastcgi_pass'; then
                  echo '‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fastcgi_pass (PHP) - –ø—Ä–∞–≤–∏–ª—å–Ω–æ!'
                elif echo \"\$NGINX_TEST\" | grep -A 10 'location.*lead-proxy' | grep -q 'proxy_pass.*1c'; then
                  echo '‚ùå –û–®–ò–ë–ö–ê: –ù–∞–π–¥–µ–Ω proxy_pass –Ω–∞ 1C! –≠—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PHP!'
                  exit 1
                else
                  echo '‚ö†Ô∏è  Warning: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è'
                fi
              else
                echo '‚ö†Ô∏è  Warning: Location –±–ª–æ–∫ –¥–ª—è lead-proxy –Ω–µ –Ω–∞–π–¥–µ–Ω'
              fi
            else
              echo '‚ùå –û–®–ò–ë–ö–ê: sudo —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${SERVER_USER}!'
              echo ''
              echo '–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:'
              echo '  –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: '$(whoami)
              echo '  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ sudoers:'
              if sudo test -f /etc/sudoers.d/${SERVER_USER} 2>/dev/null; then
                echo '    –§–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ:'
                sudo cat /etc/sudoers.d/${SERVER_USER} 2>/dev/null | sed 's/^/      /' || echo '      –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å'
                echo '    –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª:'
                sudo ls -la /etc/sudoers.d/${SERVER_USER} 2>/dev/null || echo '      –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å'
              else
                echo '    –§–∞–π–ª –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!'
              fi
              echo ''
              echo '–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ NOPASSWD –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ–¥ root:'
              echo '  echo \"${SERVER_USER} ALL=(ALL) NOPASSWD: /usr/bin/nginx, /bin/systemctl, /usr/sbin/service, /bin/sed, /bin/cp, /bin/mv, /bin/mkdir, /usr/bin/awk\" | sudo tee /etc/sudoers.d/${SERVER_USER}'
              echo '  sudo chmod 0440 /etc/sudoers.d/${SERVER_USER}'
              echo '  sudo visudo -c'
              echo ''
              echo '–í–ê–ñ–ù–û: –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤ —Ñ–∞–π–ª–µ —É–∫–∞–∑–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (${SERVER_USER}), –∞ –Ω–µ USERNAME –∏–ª–∏ –¥—Ä—É–≥–æ–π!'
              exit 1
            fi
          " || { echo '‚ùå –û–®–ò–ë–ö–ê: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx –Ω–µ —É–¥–∞–ª–∞—Å—å!'; exit 1; }
          
          echo "‚úÖ Deployment completed successfully!"
