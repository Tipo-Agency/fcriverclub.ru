name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
      
      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${SERVER_PATH}"
          
          # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –ø–∞–ø–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—É–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏)
          echo "Cleaning old files on server..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            cd ${SERVER_PATH} && 
            rm -rf * .[^.]* 2>/dev/null || true &&
            find . -mindepth 1 -delete 2>/dev/null || true
          "
          
          # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx –¥–ª—è API –ø—Ä–æ–∫—Å–∏
          echo "Copying nginx API proxy config..."
          scp -o StrictHostKeyChecking=no nginx-api-proxy.conf ${SERVER_USER}@${SERVER_HOST}:/tmp/nginx-api-proxy.conf
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ dist –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          echo "Copying new files to server..."
          scp -o StrictHostKeyChecking=no -r dist/* ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/
          
          # –ö–æ–ø–∏—Ä—É–µ–º PHP –ø—Ä–æ–∫—Å–∏ —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          echo "Copying PHP proxy file..."
          scp -o StrictHostKeyChecking=no api/lead-proxy.php ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/api/lead-proxy.php
          
          # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∞–π–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, .htaccess), —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
          # scp -o StrictHostKeyChecking=no -r dist/.[^.]* ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/ 2>/dev/null || true
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º nginx –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è /api/lead-proxy
          echo "Configuring nginx for API proxy..."
          ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "
            # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
            sudo mkdir -p /etc/nginx/includes
            sudo cp /tmp/nginx-api-proxy.conf /etc/nginx/includes/api-proxy.conf
            
            # –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ nginx
            NGINX_CONF=\$(ls /etc/nginx/sites-enabled/*.conf 2>/dev/null | head -1)
            if [ -z \"\$NGINX_CONF\" ]; then
              NGINX_CONF=\"/etc/nginx/sites-available/default\"
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx
            if ! grep -q 'include.*api-proxy.conf' \"\$NGINX_CONF\" 2>/dev/null; then
              # –î–æ–±–∞–≤–ª—è–µ–º include –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–µ–π —Å–∫–æ–±–∫–æ–π server –±–ª–æ–∫–∞
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º awk –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏
              sudo awk '/^[[:space:]]*server[[:space:]]*{/,/^[[:space:]]*}/ {
                if (/^[[:space:]]*}/ && !added) {
                  print \"    include /etc/nginx/includes/api-proxy.conf;\"
                  added=1
                }
                print
              }' \"\$NGINX_CONF\" > \"\$NGINX_CONF.tmp\" && sudo mv \"\$NGINX_CONF.tmp\" \"\$NGINX_CONF\"
              echo '‚ÑπÔ∏è  –î–æ–±–∞–≤–ª–µ–Ω include api-proxy.conf –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx'
            else
              echo '‚ÑπÔ∏è  Include api-proxy.conf —É–∂–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏'
            fi
            
            # –£–¥–∞–ª—è–µ–º –í–°–ï –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ location –±–ª–æ–∫–∏ –¥–ª—è /api/lead-proxy –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞
            echo 'üîç –ü–æ–∏—Å–∫ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö location –±–ª–æ–∫–æ–≤...'
            # –£–¥–∞–ª—è–µ–º location = /api/lead-proxy
            sudo sed -i '/location[[:space:]]*=[[:space:]]*\/api\/lead-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
            # –£–¥–∞–ª—è–µ–º location /api/lead-proxy
            sudo sed -i '/location[[:space:]]*\/api\/lead-proxy/,/^[[:space:]]*}/d' \"\$NGINX_CONF\" 2>/dev/null || true
            echo '‚úÖ –ö–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ location –±–ª–æ–∫–∏ —É–¥–∞–ª–µ–Ω—ã (–µ—Å–ª–∏ –±—ã–ª–∏)'
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—â–µ —Ä–∞–∑ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
            if grep -q 'location.*\/api\/lead-proxy' \"\$NGINX_CONF\" 2>/dev/null; then
              echo '‚ö†Ô∏è  Warning: –í—Å–µ –µ—â–µ –µ—Å—Ç—å location /api/lead-proxy –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ñ–∏–≥–µ!'
              sudo grep -n 'location.*\/api\/lead-proxy' \"\$NGINX_CONF\" || true
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
            echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:'
            sudo nginx -t
            
            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º nginx, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            echo 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ nginx...'
            sudo systemctl reload nginx 2>/dev/null || sudo service nginx reload 2>/dev/null || sudo nginx -s reload
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ nginx —Ä–∞–±–æ—Ç–∞–µ—Ç
            if sudo systemctl is-active --quiet nginx || sudo service nginx status > /dev/null 2>&1; then
              echo '‚úÖ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞'
            else
              echo '‚ö†Ô∏è Warning: nginx –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω'
            fi
          " || echo "‚ö†Ô∏è  Warning: nginx configuration step failed, but deployment continues"
          
          # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
          # ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} "cd ${SERVER_PATH} && pm2 restart app || true"
          
          echo "‚úÖ Deployment completed successfully! All old files were removed and replaced."
